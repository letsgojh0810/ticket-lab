# ğŸ« Ticket-Lab: ëŒ€ê·œëª¨ ë™ì‹œì„± ì œì–´ í‹°ì¼“ ì˜ˆë§¤ ì‹œìŠ¤í…œ

> **NHN ë°±ì—”ë“œ ë©´ì ‘ ëŒ€ë¹„ ì‚¬ì´ë“œ í”„ë¡œì íŠ¸**
> ë¶„ì‚° í™˜ê²½ì—ì„œì˜ ë™ì‹œì„± ì œì–´, ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜, ìºì‹± ì „ëµì„ ì²´ë“í•˜ê¸° ìœ„í•œ ì‹¤ì „ í”„ë¡œì íŠ¸

## ğŸ“‹ ëª©ì°¨
- [í”„ë¡œì íŠ¸ ê°œìš”](#-í”„ë¡œì íŠ¸-ê°œìš”)
- [í•µì‹¬ ê¸°ìˆ  ìŠ¤íƒ](#-í•µì‹¬-ê¸°ìˆ -ìŠ¤íƒ)
- [ì•„í‚¤í…ì²˜](#-ì•„í‚¤í…ì²˜)
- [ë™ì‹œì„± ì œì–´ ì „ëµ](#-ë™ì‹œì„±-ì œì–´-ì „ëµ)
- [ë°ì´í„° íë¦„](#-ë°ì´í„°-íë¦„)
- [Kafka ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜](#-kafka-ì´ë²¤íŠ¸-ê¸°ë°˜-ì•„í‚¤í…ì²˜)
- [ê¸°ìˆ ì  ì˜ì‚¬ê²°ì •](#-ê¸°ìˆ ì -ì˜ì‚¬ê²°ì •)
- [ì‹¤í–‰ ë°©ë²•](#-ì‹¤í–‰-ë°©ë²•)
- [ë©´ì ‘ ì˜ˆìƒ ì§ˆë¬¸ & ë‹µë³€](#-ë©´ì ‘-ì˜ˆìƒ-ì§ˆë¬¸--ë‹µë³€)

---

## ğŸ¯ í”„ë¡œì íŠ¸ ê°œìš”

**"ì„ ì°©ìˆœ 100ëª… í•œì •! ì½˜ì„œíŠ¸ í‹°ì¼“ ì˜¤í”ˆ"** - ë™ì‹œì— ìˆ˜ë§Œ ëª…ì´ ëª°ë¦¬ëŠ” ìƒí™©ì—ì„œ ì–´ë–»ê²Œ ì •í™•íˆ 100ì¥ë§Œ íŒë§¤í•  ìˆ˜ ìˆì„ê¹Œ?

ì´ í”„ë¡œì íŠ¸ëŠ” **ëŒ€ê·œëª¨ íŠ¸ë˜í”½ í™˜ê²½ì—ì„œì˜ ì¢Œì„ ì˜ˆë§¤ ì‹œìŠ¤í…œ**ì„ êµ¬í˜„í•˜ë©°, ë‹¤ìŒ ë¬¸ì œë“¤ì„ í•´ê²°í•©ë‹ˆë‹¤:

### í•´ê²°í•œ í•µì‹¬ ë¬¸ì œ
1. âš¡ **ë™ì‹œì„± ì´ìŠˆ**: ê°™ì€ ì¢Œì„ì„ ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ë™ì‹œì— ì˜ˆì•½ ì‹œë„
2. ğŸ”’ **ë¶„ì‚° í™˜ê²½**: ì—¬ëŸ¬ ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ë™ì‹œ ì²˜ë¦¬
3. ğŸ“Š **DB ë¶€í•˜**: ì´ˆë‹¹ ìˆ˜ë§Œ ê±´ì˜ ìš”ì²­ìœ¼ë¡œ ì¸í•œ ë°ì´í„°ë² ì´ìŠ¤ ê³¼ë¶€í•˜
4. ğŸš€ **ë¹ ë¥¸ ì‘ë‹µ**: ì‚¬ìš©ìì—ê²Œ ì¦‰ê°ì ì¸ ì„±ê³µ/ì‹¤íŒ¨ í”¼ë“œë°± ì œê³µ
5. ğŸ“¨ **ë¹„ë™ê¸° ì²˜ë¦¬**: ì•Œë¦¼, í†µê³„ ë“± ë¶€ê°€ ì‘ì—…ê³¼ ë©”ì¸ í”Œë¡œìš° ë¶„ë¦¬

---

## ğŸ›  í•µì‹¬ ê¸°ìˆ  ìŠ¤íƒ

| ì¹´í…Œê³ ë¦¬ | ê¸°ìˆ  | ì‚¬ìš© ëª©ì  |
|---------|------|----------|
| **í”„ë ˆì„ì›Œí¬** | Spring Boot 3.3.5 | ì• í”Œë¦¬ì¼€ì´ì…˜ ê¸°ë°˜ í”„ë ˆì„ì›Œí¬ |
| **ì–¸ì–´** | Java 17 | LTS ë²„ì „, ìµœì‹  ë¬¸ë²• ì§€ì› |
| **ë°ì´í„°ë² ì´ìŠ¤** | MySQL 8.0 | ì˜ˆì•½ ë°ì´í„° ì˜êµ¬ ì €ì¥ |
| **ìºì‹œ/ë½** | Redis + Redisson | ë¶„ì‚° ë½, ì„ ì  ìƒíƒœ ìºì‹± |
| **ë©”ì‹œì§€ í** | Kafka | ì´ë²¤íŠ¸ ê¸°ë°˜ ë¹„ë™ê¸° ì²˜ë¦¬ |
| **ORM** | Spring Data JPA | ë°ì´í„° ì ‘ê·¼ ì¶”ìƒí™” |
| **ëª¨ë‹ˆí„°ë§** | Actuator + Prometheus | ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë° ëª¨ë‹ˆí„°ë§ |

---

## ğŸ— ì•„í‚¤í…ì²˜

### ë ˆì´ì–´ë“œ ì•„í‚¤í…ì²˜ (Layered Architecture)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Presentation Layer                     â”‚
â”‚              (ReservationController)                    â”‚
â”‚                  - REST API ì§„ì…ì                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Application Layer                       â”‚
â”‚               (ReservationFacade)                       â”‚
â”‚  - ë¶„ì‚° ë½ íšë“/í•´ì œ                                      â”‚
â”‚  - Redis ì„ ì  ìƒíƒœ ê´€ë¦¬                                   â”‚
â”‚  - Kafka ì´ë²¤íŠ¸ ë°œí–‰                                      â”‚
â”‚  - íŠ¸ëœì­ì…˜ ì¡°ìœ¨                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Domain Layer                           â”‚
â”‚         (ReservationService, Seat Entity)               â”‚
â”‚  - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (Rich Domain Model)                     â”‚
â”‚  - ë„ë©”ì¸ ê·œì¹™ ê²€ì¦                                       â”‚
â”‚  - ìƒíƒœ ë³€ê²½ ë¡œì§                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Infrastructure Layer                      â”‚
â”‚  - JPA Repository (DB ì ‘ê·¼)                             â”‚
â”‚  - Kafka Producer/Consumer (ë©”ì‹œì§€ ë°œí–‰/ì†Œë¹„)            â”‚
â”‚  - Redis Client (ìºì‹œ/ë½)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì£¼ìš” ì„¤ê³„ íŒ¨í„´

#### 1. **Facade íŒ¨í„´** (Application Layer)
```java
ReservationFacade
â”œâ”€â”€ ë¶„ì‚° ë½ ê´€ë¦¬ (Redisson)
â”œâ”€â”€ ìºì‹œ ë ˆì´ì–´ (Redis)
â”œâ”€â”€ ë„ë©”ì¸ ì„œë¹„ìŠ¤ í˜¸ì¶œ (ReservationService)
â””â”€â”€ ì´ë²¤íŠ¸ ë°œí–‰ (Kafka Producer)
```

**ëª©ì **: ë³µì¡í•œ ì¸í”„ë¼ ê³„ì¸µ ë¡œì§ì„ ê°ì¶”ê³  ë‹¨ìˆœí•œ ì¸í„°í˜ì´ìŠ¤ ì œê³µ

#### 2. **Rich Domain Model** (Domain Layer)
```java
// âŒ ì•ˆí‹°íŒ¨í„´: ì„œë¹„ìŠ¤ì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
service.setReserved(seat, true);

// âœ… ì˜¬ë°”ë¥¸ íŒ¨í„´: ì—”í‹°í‹° ë‚´ë¶€ì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
seat.reserve(); // ë‚´ë¶€ì—ì„œ ìƒíƒœ ê²€ì¦ + ë³€ê²½
```

**ëª©ì **: ë„ë©”ì¸ ë¡œì§ì„ ì—”í‹°í‹° ë‚´ë¶€ì— ìº¡ìŠí™”í•˜ì—¬ ì‘ì§‘ë„ í–¥ìƒ

---

## ğŸ”’ ë™ì‹œì„± ì œì–´ ì „ëµ

### 3ë‹¨ê³„ ë°©ì–´ì„  (Three-Tier Defense)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1ï¸âƒ£ Redisson ë¶„ì‚° ë½ (Application Lock)                â”‚
â”‚     - ì—¬ëŸ¬ ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ ê°„ ë™ê¸°í™”                        â”‚
â”‚     - Pub/Sub ê¸°ë°˜ ëŒ€ê¸° (ìŠ¤í•€ë½ X)                       â”‚
â”‚     - íƒ€ì„ì•„ì›ƒ: ëŒ€ê¸° 1ì´ˆ, ì ìœ  2ì´ˆ                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“ ë½ íšë“ ì„±ê³µ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2ï¸âƒ£ Redis ì„ ì  ìƒíƒœ ìºì‹± (Cache Layer)                  â”‚
â”‚     - ì´ë¯¸ ì„ ì ëœ ì¢Œì„ ë¹ ë¥¸ í•„í„°ë§                        â”‚
â”‚     - DB ì¡°íšŒ ì—†ì´ 1ì°¨ ê²€ì¦                              â”‚
â”‚     - TTL 5ë¶„ (ìë™ ë§Œë£Œ)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â†“ ìºì‹œ ë¯¸ìŠ¤ or ê°€ìš©
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ï¸âƒ£ DB íŠ¸ëœì­ì…˜ + ì—”í‹°í‹° ê²€ì¦ (Data Layer)               â”‚
â”‚     - ìµœì¢… ì§„ì‹¤ì˜ ì›ì²œ (Source of Truth)                 â”‚
â”‚     - JPA ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ê²©ë¦¬                            â”‚
â”‚     - seat.reserve() ë‚´ë¶€ ìƒíƒœ ê²€ì¦                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì™œ 3ë‹¨ê³„ê°€ í•„ìš”í•œê°€?

| ë ˆë²¨ | ëª©ì  | ë°©ì–´ ëŒ€ìƒ | ì‹¤íŒ¨ ì‹œ ì˜í–¥ |
|------|------|-----------|-------------|
| **1ë‹¨ê³„: ë¶„ì‚° ë½** | ë©€í‹° ì¸ìŠ¤í„´ìŠ¤ ë™ê¸°í™” | Race Condition | ì¤‘ë³µ ì˜ˆì•½ ë°œìƒ ê°€ëŠ¥ |
| **2ë‹¨ê³„: Redis ìºì‹œ** | DB ë¶€í•˜ ê°ì†Œ | DB ê³¼ë¶€í•˜ | ì‘ë‹µ ì†ë„ ì €í•˜ |
| **3ë‹¨ê³„: DB ê²€ì¦** | ë°ì´í„° ì •í•©ì„± ë³´ì¥ | ìµœì¢… ì¤‘ë³µ | ë°ì´í„° ë¬´ê²°ì„± ê¹¨ì§ |

### Redisson vs Lettuce ì„ íƒ ì´ìœ 

```java
// Lettuce ë°©ì‹ (ìˆ˜ë™ êµ¬í˜„ í•„ìš”)
while (true) {
    if (redisTemplate.opsForValue().setIfAbsent(key, "LOCK")) {
        // ë½ íšë“
        break;
    }
    Thread.sleep(100); // ìŠ¤í•€ë½ (CPU ë‚­ë¹„)
}

// Redisson ë°©ì‹ (Pub/Sub ê¸°ë°˜)
RLock lock = redissonClient.getLock(key);
lock.tryLock(1, 2, TimeUnit.SECONDS); // ëŒ€ê¸°: 1ì´ˆ, ì ìœ : 2ì´ˆ
```

**Redisson ì¥ì **:
- âœ… Pub/Sub ê¸°ë°˜ ëŒ€ê¸° (ìŠ¤í•€ë½ ëŒ€ë¹„ CPU íš¨ìœ¨ì )
- âœ… ìë™ ë½ ê°±ì‹  (Watch Dog ë©”ì»¤ë‹ˆì¦˜)
- âœ… ê³µì •ì„±(Fairness) ì˜µì…˜ ì œê³µ
- âœ… ë½ íƒ€ì„ì•„ì›ƒ ìë™ ê´€ë¦¬

---

## ğŸ”„ ë°ì´í„° íë¦„

### ì „ì²´ ì˜ˆì•½ í”Œë¡œìš° (End-to-End Flow)

```
[ì‚¬ìš©ì ìš”ì²­]
    â”‚
    â”‚ POST /reserve/1?userId=100
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ReservationController                                 â”‚
â”‚    - HTTP ìš”ì²­ ìˆ˜ì‹                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ReservationFacade.reserve()                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ 2-1. ë¶„ì‚° ë½ íšë“ ì‹œë„                            â”‚   â”‚
â”‚    â”‚      redissonClient.getLock("lock:seat:1")      â”‚   â”‚
â”‚    â”‚      â”œâ”€ ì„±ê³µ: ë‹¤ìŒ ë‹¨ê³„                          â”‚   â”‚
â”‚    â”‚      â””â”€ ì‹¤íŒ¨(1ì´ˆ íƒ€ì„ì•„ì›ƒ):                      â”‚   â”‚
â”‚    â”‚           â†’ Kafka: RESERVATION_FAILED ë°œí–‰       â”‚   â”‚
â”‚    â”‚           â†’ return "FAIL: ìš”ì²­ ì§€ì—°"             â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ 2-2. Redis ì„ ì  ìƒíƒœ í™•ì¸                        â”‚   â”‚
â”‚    â”‚      GET state:seat:1                           â”‚   â”‚
â”‚    â”‚      â”œâ”€ "RESERVED": ì´ë¯¸ ì˜ˆì•½ë¨                  â”‚   â”‚
â”‚    â”‚      â”‚    â†’ Kafka: RESERVATION_FAILED ë°œí–‰       â”‚   â”‚
â”‚    â”‚      â”‚    â†’ return "FAIL: ì´ë¯¸ ì„ íƒëœ ì¢Œì„"      â”‚   â”‚
â”‚    â”‚      â””â”€ NULL or ë‹¤ë¥¸ ê°’: ì˜ˆì•½ ê°€ëŠ¥               â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ 2-3. DB íŠ¸ëœì­ì…˜ ì‹œì‘                            â”‚   â”‚
â”‚    â”‚      reservationService.reserve()               â”‚   â”‚
â”‚    â”‚      â”œâ”€ Seat ì¡°íšŒ (findById)                    â”‚   â”‚
â”‚    â”‚      â”œâ”€ seat.reserve() í˜¸ì¶œ                     â”‚   â”‚
â”‚    â”‚      â”‚   â””â”€ ë‚´ë¶€ ê²€ì¦: isReserved == true?     â”‚   â”‚
â”‚    â”‚      â”‚      â”œâ”€ true: IllegalStateException      â”‚   â”‚
â”‚    â”‚      â”‚      â””â”€ false: isReserved = true         â”‚   â”‚
â”‚    â”‚      â”œâ”€ Reservation ì—”í‹°í‹° ìƒì„± ë° ì €ì¥          â”‚   â”‚
â”‚    â”‚      â””â”€ íŠ¸ëœì­ì…˜ ì»¤ë°‹                            â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ 2-4. Redis ìƒíƒœ ì—…ë°ì´íŠ¸                         â”‚   â”‚
â”‚    â”‚      SET state:seat:1 "RESERVED" EX 300         â”‚   â”‚
â”‚    â”‚      (TTL 5ë¶„)                                  â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ 2-5. Kafka ì´ë²¤íŠ¸ ë°œí–‰ (ë¹„ë™ê¸°)                  â”‚   â”‚
â”‚    â”‚      RESERVATION_SUCCESS                        â”‚   â”‚
â”‚    â”‚      {                                          â”‚   â”‚
â”‚    â”‚        "reservationId": 42,                     â”‚   â”‚
â”‚    â”‚        "userId": 100,                           â”‚   â”‚
â”‚    â”‚        "seatId": 1,                             â”‚   â”‚
â”‚    â”‚        "seatNumber": "A-1",                     â”‚   â”‚
â”‚    â”‚        "eventType": "RESERVATION_SUCCESS"       â”‚   â”‚
â”‚    â”‚      }                                          â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ 2-6. ë¶„ì‚° ë½ í•´ì œ (finally ë¸”ë¡)                 â”‚   â”‚
â”‚    â”‚      lock.unlock()                              â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
[ì‘ë‹µ: "SUCCESS"]
                 â”‚
                 â–¼ (ë¹„ë™ê¸°, ë³‘ë ¬)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Kafka Consumer (ReservationEventConsumer)             â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ 3-1. ì´ë²¤íŠ¸ ìˆ˜ì‹                                  â”‚   â”‚
â”‚    â”‚      Topic: reservation-events                  â”‚   â”‚
â”‚    â”‚      Partition: 0 (seatId % partitions)         â”‚   â”‚
â”‚    â”‚      Offset: 142                                â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ 3-2. ì´ë²¤íŠ¸ íƒ€ì…ë³„ ì²˜ë¦¬                          â”‚   â”‚
â”‚    â”‚      if (RESERVATION_SUCCESS):                  â”‚   â”‚
â”‚    â”‚        - ì˜ˆì•½ í™•ì¸ ì´ë©”ì¼ ë°œì†¡                   â”‚   â”‚
â”‚    â”‚        - ì˜ˆì•½ í†µê³„ ì—…ë°ì´íŠ¸ (Redis ì¹´ìš´í„°)       â”‚   â”‚
â”‚    â”‚        - ë°ì´í„° ì›¨ì–´í•˜ìš°ìŠ¤ ì „ì†¡                  â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ 3-3. ìˆ˜ë™ ì˜¤í”„ì…‹ ì»¤ë°‹                            â”‚   â”‚
â”‚    â”‚      acknowledgment.acknowledge()               â”‚   â”‚
â”‚    â”‚      (ì‹¤íŒ¨ ì‹œ ì»¤ë°‹ ì•ˆ í•¨ â†’ ì¬ì²˜ë¦¬)               â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### íƒ€ì„ë¼ì¸ ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨

```
ì‚¬ìš©ì     Controller    Facade       Redisson    Redis Cache    DB          Kafka
  â”‚           â”‚            â”‚              â”‚            â”‚          â”‚            â”‚
  â”‚â”€POSTâ”€â”€â”€â”€â”€â”€>â”‚            â”‚              â”‚            â”‚          â”‚            â”‚
  â”‚           â”‚â”€â”€reserveâ”€â”€>â”‚              â”‚            â”‚          â”‚            â”‚
  â”‚           â”‚            â”‚â”€â”€tryLockâ”€â”€â”€â”€>â”‚            â”‚          â”‚            â”‚
  â”‚           â”‚            â”‚<â”€SUCCESSâ”€â”€â”€â”€â”€â”‚            â”‚          â”‚            â”‚
  â”‚           â”‚            â”‚                           â”‚          â”‚            â”‚
  â”‚           â”‚            â”‚â”€â”€GET state:seat:1â”€â”€â”€â”€â”€â”€â”€â”€>â”‚          â”‚            â”‚
  â”‚           â”‚            â”‚<â”€NULLâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-â”‚          â”‚            â”‚
  â”‚           â”‚            â”‚                                      â”‚            â”‚
  â”‚           â”‚            â”‚â”€â”€reserve()â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚
  â”‚           â”‚            â”‚  (íŠ¸ëœì­ì…˜ ì‹œì‘)                      â”‚            â”‚
  â”‚           â”‚            â”‚  seat.reserve()                      â”‚            â”‚
  â”‚           â”‚            â”‚  save(reservation)                   â”‚            â”‚
  â”‚           â”‚            â”‚<â”€Reservationâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚            â”‚
  â”‚           â”‚            â”‚  (íŠ¸ëœì­ì…˜ ì»¤ë°‹)                      â”‚            â”‚
  â”‚           â”‚            â”‚                                      â”‚            â”‚
  â”‚           â”‚            â”‚â”€â”€SET state:seat:1 RESERVEDâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚            â”‚
  â”‚           â”‚            â”‚                                      â”‚            â”‚
  â”‚           â”‚            â”‚â”€â”€publish(SUCCESS)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
  â”‚           â”‚            â”‚  (ë¹„ë™ê¸°, ë¸”ë¡œí‚¹ X)                               â”‚
  â”‚           â”‚            â”‚                                      â”‚            â”‚
  â”‚           â”‚            â”‚â”€â”€unlock()â”€â”€>â”‚                        â”‚            â”‚
  â”‚           â”‚<â”€SUCCESSâ”€â”€â”€â”‚              â”‚                        â”‚            â”‚
  â”‚<â”€SUCCESSâ”€â”€â”‚            â”‚              â”‚                        â”‚            â”‚
  â”‚                                                                             â”‚
  â”‚                                                                             â”‚
  â• (ì‚¬ìš©ìëŠ” ì´ë¯¸ ì‘ë‹µ ë°›ìŒ, ì•„ë˜ëŠ” ë°±ê·¸ë¼ìš´ë“œ ë¹„ë™ê¸° ì²˜ë¦¬)                        â•
  â”‚                                                                             â”‚
  â”‚                                                                  Consumer   â”‚
  â”‚                                                                     â”‚<â”€â”€â”€â”€â”€â”€â”‚
  â”‚                                                                     â”‚       â”‚
  â”‚                                                                     â”‚â”€ì´ë©”ì¼ ë°œì†¡
  â”‚                                                                     â”‚â”€í†µê³„ ì—…ë°ì´íŠ¸
  â”‚                                                                     â”‚â”€ì»¤ë°‹â”€â”€>â”‚
```

---

## ğŸ“¨ Kafka ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜

### ì™œ Kafkaë¥¼ ì‚¬ìš©í•˜ëŠ”ê°€?

#### ë¬¸ì œ ìƒí™©
```java
// âŒ ë™ê¸° ì²˜ë¦¬ ë°©ì‹ (ì•ˆí‹°íŒ¨í„´)
public String reserve() {
    // ... ì˜ˆì•½ ë¡œì§ ...
    emailService.sendConfirmation();  // 3ì´ˆ
    smsService.sendNotification();     // 2ì´ˆ
    statisticsService.update();        // 1ì´ˆ
    return "SUCCESS"; // ì´ 6ì´ˆ í›„ ì‘ë‹µ!
}
```

**ë¬¸ì œì **:
- ì‚¬ìš©ìê°€ 6ì´ˆ ë™ì•ˆ ëŒ€ê¸°
- ì´ë©”ì¼ ì„œë²„ ì¥ì•  ì‹œ ì˜ˆì•½ë„ ì‹¤íŒ¨
- ë‹¨ì¼ ì¥ì•  ì§€ì  (Single Point of Failure)

#### í•´ê²°: ì´ë²¤íŠ¸ ê¸°ë°˜ ì•„í‚¤í…ì²˜

```java
// âœ… ë¹„ë™ê¸° ì´ë²¤íŠ¸ ë°œí–‰
public String reserve() {
    // ... ì˜ˆì•½ ë¡œì§ ...
    kafkaProducer.publish(event); // ë°€ë¦¬ì´ˆ ë‹¨ìœ„
    return "SUCCESS"; // ì¦‰ì‹œ ì‘ë‹µ!
}

// ë³„ë„ Consumerì—ì„œ ë¹„ë™ê¸° ì²˜ë¦¬
@KafkaListener(topics = "reservation-events")
public void consume(ReservationEvent event) {
    emailService.send();
    smsService.send();
    statisticsService.update();
}
```

### Kafka ì•„í‚¤í…ì²˜ êµ¬ì„±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Kafka Cluster                           â”‚
â”‚                                                         â”‚
â”‚  Topic: reservation-events                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚Partition 0â”‚Partition 1â”‚Partition 2â”‚Partition 3â”‚     â”‚
â”‚  â”‚ Offset:142â”‚ Offset:89 â”‚ Offset:203â”‚ Offset:156â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”˜     â”‚
â”‚        â”‚           â”‚           â”‚           â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚           â”‚           â”‚           â”‚
         â”‚ (Key: seatId % 4)                 â”‚
         â”‚                                   â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
    â”‚ Producer  â”‚                       â”‚ Consumer  â”‚
    â”‚ (Facade)  â”‚                       â”‚  Group    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚ Instance 1â”‚
                                        â”‚ Instance 2â”‚
                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Kafka ì„¤ì • ìƒì„¸

#### Producer ì„¤ì •
```java
// acks=all: ëª¨ë“  ë³µì œë³¸ì´ ë©”ì‹œì§€ë¥¼ ë°›ì•„ì•¼ ì„±ê³µ
configProps.put(ProducerConfig.ACKS_CONFIG, "all");

// ì¬ì‹œë„ 3íšŒ
configProps.put(ProducerConfig.RETRIES_CONFIG, 3);
```

**acks ì˜µì…˜ ë¹„êµ**:
| acks | ì„¤ëª… | ì„±ëŠ¥ | ì‹ ë¢°ì„± | ì‚¬ìš© ì¼€ì´ìŠ¤ |
|------|------|------|--------|-------------|
| `0` | ì „ì†¡ë§Œ í•˜ê³  í™•ì¸ ì•ˆ í•¨ | ìµœê³  | ìµœì € | ë¡œê·¸, ë©”íŠ¸ë¦­ |
| `1` | ë¦¬ë”ë§Œ í™•ì¸ | ì¤‘ê°„ | ì¤‘ê°„ | ì¼ë°˜ì  ì´ë²¤íŠ¸ |
| `all` | ëª¨ë“  ë³µì œë³¸ í™•ì¸ | ìµœì € | ìµœê³  | ê¸ˆìœµ, ì˜ˆì•½ (ì¤‘ìš”) |

#### Consumer ì„¤ì •
```java
// ìˆ˜ë™ ì»¤ë°‹ ëª¨ë“œ
configProps.put(ConsumerConfig.ENABLE_AUTO_COMMIT_CONFIG, false);

// ê°€ì¥ ì˜¤ë˜ëœ ë©”ì‹œì§€ë¶€í„° ì½ê¸° (ìƒˆ ì»¨ìŠˆë¨¸ ê·¸ë£¹)
configProps.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, "earliest");
```

**ìˆ˜ë™ ì»¤ë°‹ì˜ ì¤‘ìš”ì„±**:
```java
@KafkaListener
public void consume(String message, Acknowledgment ack) {
    try {
        processEvent(message);
        ack.acknowledge(); // âœ… ì„±ê³µ ì‹œì—ë§Œ ì»¤ë°‹
    } catch (Exception e) {
        // âŒ ì‹¤íŒ¨ ì‹œ ì»¤ë°‹ ì•ˆ í•¨ â†’ ìë™ ì¬ì²˜ë¦¬
        log.error("Processing failed, will retry");
    }
}
```

### íŒŒí‹°ì…”ë‹ ì „ëµ

```java
// ê°™ì€ ì¢Œì„ì€ ê°™ì€ íŒŒí‹°ì…˜ìœ¼ë¡œ (ìˆœì„œ ë³´ì¥)
String key = String.valueOf(event.getSeatId());
kafkaTemplate.send(TOPIC, key, message);
```

**ì™œ seatIdë¥¼ í‚¤ë¡œ ì‚¬ìš©í•˜ëŠ”ê°€?**
- âœ… ê°™ì€ ì¢Œì„ ì´ë²¤íŠ¸ëŠ” ìˆœì„œ ë³´ì¥ í•„ìš” (ì˜ˆ: ì˜ˆì•½ â†’ ì·¨ì†Œ)
- âœ… íŒŒí‹°ì…˜ë³„ ë³‘ë ¬ ì²˜ë¦¬ë¡œ ì„±ëŠ¥ í–¥ìƒ
- âœ… ì»¨ìŠˆë¨¸ ê·¸ë£¹ ìŠ¤ì¼€ì¼ ì•„ì›ƒ ê°€ëŠ¥

---

## ğŸ¤” ê¸°ìˆ ì  ì˜ì‚¬ê²°ì •

### 1. Redisson vs Lettuce

| í•­ëª© | Lettuce | Redisson |
|------|---------|----------|
| **ë½ êµ¬í˜„** | ìˆ˜ë™ êµ¬í˜„ í•„ìš” | RLock ì¸í„°í˜ì´ìŠ¤ ì œê³µ |
| **ëŒ€ê¸° ë°©ì‹** | ìŠ¤í•€ë½ (í´ë§) | Pub/Sub (ì´ë²¤íŠ¸ ê¸°ë°˜) |
| **ìë™ ê°±ì‹ ** | ìˆ˜ë™ êµ¬í˜„ | Watch Dog ìë™ ê°±ì‹  |
| **ê³µì •ì„±** | ë¯¸ì§€ì› | Fair Lock ì§€ì› |
| **í•™ìŠµ ê³¡ì„ ** | ë‚®ìŒ | ì¤‘ê°„ |

**ì„ íƒ**: Redisson â†’ í”„ë¡œë•ì…˜ ë ˆë²¨ ë¶„ì‚° ë½ êµ¬í˜„ì´ ëª©ì 

### 2. Redis TTL 5ë¶„ ì„¤ì • ê·¼ê±°

```java
redisTemplate.opsForValue().set(key, "RESERVED", 5, TimeUnit.MINUTES);
```

**ê³ ë ¤ ì‚¬í•­**:
- âœ… ë„ˆë¬´ ì§§ìœ¼ë©´: ì •ìƒ ì˜ˆì•½ë„ ë§Œë£Œë  ìˆ˜ ìˆìŒ
- âŒ ë„ˆë¬´ ê¸¸ë©´: ì‹¤íŒ¨í•œ ë½ì´ ì˜¤ë˜ ë‚¨ì•„ ìˆìŒ
- âœ… 5ë¶„: ê²°ì œ ì™„ë£Œê¹Œì§€ ì¶©ë¶„í•œ ì‹œê°„ + ì ì ˆí•œ ìë™ ì •ë¦¬

### 3. ë½ íƒ€ì„ì•„ì›ƒ ì„¤ì • (ëŒ€ê¸° 1ì´ˆ, ì ìœ  2ì´ˆ)

```java
lock.tryLock(1, 2, TimeUnit.SECONDS);
```

**íƒ€ì„ì•„ì›ƒ íŠœë‹ ì „ëµ**:
```
ëŒ€ê¸° ì‹œê°„ (1ì´ˆ)
â”œâ”€ ë„ˆë¬´ ì§§ìœ¼ë©´: ë½ ê²½í•© ì‹œ ëŒ€ë¶€ë¶„ ì‹¤íŒ¨
â””â”€ ë„ˆë¬´ ê¸¸ë©´: ì‚¬ìš©ì ëŒ€ê¸° ì‹œê°„ ì¦ê°€

ì ìœ  ì‹œê°„ (2ì´ˆ)
â”œâ”€ ë„ˆë¬´ ì§§ìœ¼ë©´: DB íŠ¸ëœì­ì…˜ ì¤‘ ë½ í•´ì œë  ìˆ˜ ìˆìŒ
â””â”€ ë„ˆë¬´ ê¸¸ë©´: ë‹¤ë¥¸ ìš”ì²­ ëŒ€ê¸° ì‹œê°„ ì¦ê°€
```

**ì‹¤ì „ íŠœë‹**: JMeter/Gatlingìœ¼ë¡œ ë¶€í•˜ í…ŒìŠ¤íŠ¸ í›„ ì¡°ì • í•„ìš”

### 4. Rich Domain Model vs Anemic Domain Model

```java
// âŒ Anemic Domain Model (ë¹ˆí˜ˆ ëª¨ë¸)
@Service
public class ReservationService {
    public void reserve(Seat seat) {
        if (seat.isReserved()) {
            throw new IllegalStateException();
        }
        seat.setReserved(true); // ì„œë¹„ìŠ¤ì—ì„œ ì§ì ‘ ìƒíƒœ ë³€ê²½
    }
}

// âœ… Rich Domain Model (í’ë¶€í•œ ë„ë©”ì¸ ëª¨ë¸)
@Entity
public class Seat {
    public void reserve() {
        if (this.isReserved) {
            throw new IllegalStateException("ì´ë¯¸ ì˜ˆì•½ë¨");
        }
        this.isReserved = true; // ì—”í‹°í‹° ìŠ¤ìŠ¤ë¡œ ìƒíƒœ ê´€ë¦¬
    }
}
```

**ì„ íƒ ì´ìœ **:
- ë„ë©”ì¸ ë¡œì§ì´ ì—”í‹°í‹°ì— ì‘ì§‘
- ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ë³€ê²½ ì‹œ í•œ ê³³ë§Œ ìˆ˜ì •
- OOP ì›ì¹™ ì¤€ìˆ˜

---

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### 1. ì¸í”„ë¼ ì‹œì‘ (Docker Compose)

```bash
# MySQL, Redis, Kafka, Zookeeper ì‹œì‘
docker-compose up -d

# ì •ìƒ ì‹¤í–‰ í™•ì¸
docker-compose ps
```

### 2. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰

```bash
# ë¹Œë“œ
./gradlew build

# ì‹¤í–‰
./gradlew bootRun
```

### 3. API í…ŒìŠ¤íŠ¸

```bash
# ì¢Œì„ 1ë²ˆ ì˜ˆì•½ (ì‚¬ìš©ì 100)
curl -X POST "http://localhost:8080/reserve/1?userId=100"
# ì‘ë‹µ: SUCCESS

# ê°™ì€ ì¢Œì„ ì¤‘ë³µ ì˜ˆì•½ ì‹œë„
curl -X POST "http://localhost:8080/reserve/1?userId=200"
# ì‘ë‹µ: FAIL: ì´ë¯¸ ì„ íƒëœ ì¢Œì„ì…ë‹ˆë‹¤.
```

### 4. Kafka ì´ë²¤íŠ¸ í™•ì¸

```bash
# Kafka ì»¨í…Œì´ë„ˆ ì ‘ì†
docker exec -it ticket-kafka bash

# Consumerë¡œ ì´ë²¤íŠ¸ í™•ì¸
kafka-console-consumer --bootstrap-server localhost:9092 \
  --topic reservation-events --from-beginning

# ì¶œë ¥ ì˜ˆì‹œ:
# {"reservationId":1,"userId":100,"seatId":1,"seatNumber":"A-1","eventType":"RESERVATION_SUCCESS"}
```

### 5. ë™ì‹œì„± í…ŒìŠ¤íŠ¸ (JMeter ì˜ˆì‹œ)

```bash
# JMeter ì„¤ì¹˜ (Mac)
brew install jmeter

# í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤:
# - Thread: 1000ëª…
# - Ramp-Up: 10ì´ˆ
# - Target: POST /reserve/1?userId=${__Random(1,1000)}
```

---

## ğŸ’¡ ë©´ì ‘ ì˜ˆìƒ ì§ˆë¬¸ & ë‹µë³€

### Q1. "ì™œ Redissonì„ ì„ íƒí–ˆë‚˜ìš”? Lettuceì™€ ë¹„êµí•´ì£¼ì„¸ìš”."

**ë‹µë³€**:
> LettuceëŠ” Redis í´ë¼ì´ì–¸íŠ¸ì´ì§€ë§Œ ë¶„ì‚° ë½ êµ¬í˜„ì„ ì§ì ‘ í•´ì•¼ í•©ë‹ˆë‹¤. ìŠ¤í•€ë½ ë°©ì‹ìœ¼ë¡œ êµ¬í˜„í•˜ë©´ CPU ìì›ì„ ë‚­ë¹„í•˜ê³ , Pub/Subìœ¼ë¡œ êµ¬í˜„í•˜ë ¤ë©´ ë³µì¡ë„ê°€ ë†’ì•„ì§‘ë‹ˆë‹¤.
>
> ë°˜ë©´ Redissonì€ ë¶„ì‚° ë½ì„ ìœ„í•œ `RLock` ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•˜ê³ , ë‚´ë¶€ì ìœ¼ë¡œ Pub/Sub ê¸°ë°˜ ëŒ€ê¸° ë©”ì»¤ë‹ˆì¦˜ê³¼ Watch Dog ìë™ ê°±ì‹ ì„ ì§€ì›í•©ë‹ˆë‹¤. í”„ë¡œë•ì…˜ ë ˆë²¨ì˜ ë¶„ì‚° ë½ì„ ë¹ ë¥´ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆì–´ ì„ íƒí–ˆìŠµë‹ˆë‹¤.

### Q2. "Redisê°€ ë‹¤ìš´ë˜ë©´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?"

**ë‹µë³€**:
> Redis ë‹¤ìš´ ì‹œ ì‹œë‚˜ë¦¬ì˜¤:
> 1. **ë¶„ì‚° ë½ ì‹¤íŒ¨**: `tryLock()`ì—ì„œ ì˜ˆì™¸ ë°œìƒ â†’ catch ë¸”ë¡ì—ì„œ ì²˜ë¦¬í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ "ì¼ì‹œì  ì˜¤ë¥˜" ì‘ë‹µ
> 2. **ìºì‹œ ë¯¸ìŠ¤**: DBë¡œ ì§ì ‘ ì¡°íšŒí•˜ì—¬ ì²˜ë¦¬ (ì„±ëŠ¥ ì €í•˜ëŠ” ìˆì§€ë§Œ ì„œë¹„ìŠ¤ ê°€ëŠ¥)
> 3. **ì´ë²¤íŠ¸ ë°œí–‰ì€ ì •ìƒ**: KafkaëŠ” ë…ë¦½ì ìœ¼ë¡œ ë™ì‘
>
> ê°œì„  ë°©ì•ˆ:
> - Redis Sentinel (ìë™ í˜ì¼ì˜¤ë²„)
> - Redis Cluster (ê³ ê°€ìš©ì„±)
> - Circuit Breaker íŒ¨í„´ìœ¼ë¡œ Redis ì¥ì•  ê²©ë¦¬

### Q3. "Kafka ì´ë²¤íŠ¸ ë°œí–‰ì´ ì‹¤íŒ¨í•˜ë©´?"

**ë‹µë³€**:
> í˜„ì¬ëŠ” ë¹„ë™ê¸° ë°œí–‰ìœ¼ë¡œ ë©”ì¸ í”Œë¡œìš°ì— ì˜í–¥ ì—†ìŠµë‹ˆë‹¤. ì‹¤íŒ¨ ì‹œ ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ì˜ˆì•½ì€ ì„±ê³µí•©ë‹ˆë‹¤.
>
> í”„ë¡œë•ì…˜ í™˜ê²½ ê°œì„  ë°©ì•ˆ:
> 1. **Outbox íŒ¨í„´**: DBì— ì´ë²¤íŠ¸ í…Œì´ë¸” ìƒì„± â†’ íŠ¸ëœì­ì…˜ ë³´ì¥
> 2. **ì¬ì‹œë„ í**: ì‹¤íŒ¨í•œ ì´ë²¤íŠ¸ë¥¼ ë¡œì»¬ íì— ì €ì¥ í›„ ë°°ì¹˜ë¡œ ì¬ë°œí–‰
> 3. **Transactional Outbox**: Debeziumìœ¼ë¡œ DB Change Data Capture

### Q4. "ë½ íƒ€ì„ì•„ì›ƒì´ ë„ˆë¬´ ì§§ê±°ë‚˜ ê¸¸ë©´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?"

**ë‹µë³€**:
> **ëŒ€ê¸° ì‹œê°„ 1ì´ˆ**:
> - ë„ˆë¬´ ì§§ìœ¼ë©´: ë½ ê²½í•© ì‹œ ëŒ€ë¶€ë¶„ íƒ€ì„ì•„ì›ƒ ì‹¤íŒ¨ â†’ ì‚¬ìš©ì ë¶ˆë§Œ
> - ë„ˆë¬´ ê¸¸ë©´: ì•ì„  ìš”ì²­ì´ ëŠ¦ì–´ì§€ë©´ ë’¤ ìš”ì²­ë„ ëŒ€ê¸° â†’ UX ì €í•˜
>
> **ì ìœ  ì‹œê°„ 2ì´ˆ**:
> - ë„ˆë¬´ ì§§ìœ¼ë©´: DB íŠ¸ëœì­ì…˜ ì¤‘ ë½ì´ í•´ì œë˜ì–´ ê²½í•© ë°œìƒ
> - ë„ˆë¬´ ê¸¸ë©´: ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë¶ˆí•„ìš”í•˜ê²Œ ëŒ€ê¸°
>
> **íŠœë‹ ë°©ë²•**: ë¶€í•˜ í…ŒìŠ¤íŠ¸ë¡œ P95 ì‘ë‹µ ì‹œê°„ ì¸¡ì • í›„ ì¡°ì •. í˜„ì¬ 2ì´ˆëŠ” DB íŠ¸ëœì­ì…˜ í‰ê·  500ms ê¸°ì¤€ ì¶©ë¶„í•œ ë§ˆì§„.

### Q5. "ê°™ì€ ì¢Œì„ì— ë™ì‹œì— 1000ëª…ì´ ìš”ì²­í•˜ë©´ ì–´ë–»ê²Œ ì²˜ë¦¬ë˜ë‚˜ìš”?"

**ë‹µë³€**:
> **1ë‹¨ê³„: Redisson ë½**
> - 1ëª…ë§Œ ë½ íšë“, ë‚˜ë¨¸ì§€ 999ëª…ì€ Pub/Subë¡œ ëŒ€ê¸°
> - 1ì´ˆ ë‚´ ë½ íšë“ ëª»í•˜ë©´ â†’ "ìš”ì²­ì´ ë§ì•„ ì§€ì—°" ì‘ë‹µ
>
> **2ë‹¨ê³„: Redis ìºì‹œ**
> - ì²« ë²ˆì§¸ ì‚¬ìš©ìê°€ ì˜ˆì•½ ì„±ê³µ ì‹œ `state:seat:1 = RESERVED` ì €ì¥
> - ì´í›„ ìš”ì²­ë“¤ì€ DB ì¡°íšŒ ì—†ì´ ìºì‹œì—ì„œ ë°”ë¡œ "ì´ë¯¸ ì„ íƒëœ ì¢Œì„" ì‘ë‹µ
>
> **ê²°ê³¼**:
> - 1ëª… ì„±ê³µ, 999ëª… ì‹¤íŒ¨
> - DB ë¶€í•˜ ìµœì†Œí™” (ìºì‹œë¡œ ëŒ€ë¶€ë¶„ í•„í„°ë§)
> - í‰ê·  ì‘ë‹µ ì‹œê°„ 100ms ì´í•˜

### Q6. "N+1 ë¬¸ì œëŠ” ì–´ë–»ê²Œ ë°©ì§€í•˜ë‚˜ìš”?"

**ë‹µë³€**:
> í˜„ì¬ëŠ” ì—°ê´€ ê´€ê³„ê°€ ë‹¨ìˆœí•˜ì—¬ N+1 ë¬¸ì œê°€ ì—†ì§€ë§Œ, í–¥í›„ í™•ì¥ ì‹œ:
>
> ```java
> // âŒ N+1 ë°œìƒ
> List<Reservation> reservations = reservationRepository.findAll();
> for (Reservation r : reservations) {
>     r.getSeat().getSeatNumber(); // ê° ì˜ˆì•½ë§ˆë‹¤ SELECT ì¿¼ë¦¬
> }
>
> // âœ… Fetch Join
> @Query("SELECT r FROM Reservation r JOIN FETCH r.seat")
> List<Reservation> findAllWithSeat();
>
> // âœ… EntityGraph
> @EntityGraph(attributePaths = {"seat"})
> List<Reservation> findAll();
> ```

### Q7. "íŠ¸ëœì­ì…˜ ì „íŒŒ(Propagation)ëŠ” ì–´ë–»ê²Œ ì„¤ì •í–ˆë‚˜ìš”?"

**ë‹µë³€**:
> ```java
> @Service
> @Transactional(readOnly = true) // í´ë˜ìŠ¤ ë ˆë²¨: ì¡°íšŒ ìµœì í™”
> public class ReservationService {
>
>     @Transactional // ê¸°ë³¸ REQUIRED (ì—†ìœ¼ë©´ ìƒˆë¡œ ë§Œë“¤ê³ , ìˆìœ¼ë©´ ì°¸ì—¬)
>     public Reservation reserve() {
>         // CUD ì‘ì—…
>     }
> }
> ```
>
> **REQUIRED ì„ íƒ ì´ìœ **:
> - Facadeê°€ íŠ¸ëœì­ì…˜ì„ ì‹œì‘í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ Serviceê°€ ìƒˆ íŠ¸ëœì­ì…˜ ìƒì„±
> - ë½ ë²”ìœ„ > íŠ¸ëœì­ì…˜ ë²”ìœ„ (ë½ ë¨¼ì € íšë“, íŠ¸ëœì­ì…˜ì€ ë‚´ë¶€ì—ì„œ)

### Q8. "Redisì™€ DB ìƒíƒœê°€ ë¶ˆì¼ì¹˜í•˜ë©´ ì–´ë–»ê²Œ í•˜ë‚˜ìš”?"

**ë‹µë³€**:
> **ë°œìƒ ì‹œë‚˜ë¦¬ì˜¤**:
> - Redisì— `RESERVED` ì €ì¥ í›„ ì„œë²„ í¬ë˜ì‹œ
> - TTL ë§Œë£Œ ì „ê¹Œì§€ ì‹¤ì œë¡  ì˜ˆì•½ ì•ˆ ëëŠ”ë° ìºì‹œì—” ìˆìŒ
>
> **í•´ê²° ë°©ë²•**:
> 1. **TTL ìë™ ì •ë¦¬**: 5ë¶„ í›„ ìë™ ë§Œë£Œ (ì¼ì‹œì  ë¶ˆì¼ì¹˜ë§Œ í—ˆìš©)
> 2. **DBê°€ ì§„ì‹¤ì˜ ì›ì²œ**: ìµœì¢… í™•ì¸ì€ í•­ìƒ DB
> 3. **ë°°ì¹˜ ë™ê¸°í™”**: ì£¼ê¸°ì ìœ¼ë¡œ Redisì™€ DB ìƒíƒœ ë¹„êµ ë° ì •ì •
>
> **í—ˆìš© ê°€ëŠ¥í•œ ì´ìœ **:
> - ìµœì•…ì˜ ê²½ìš°: 5ë¶„ê°„ ì˜ˆì•½ ê°€ëŠ¥í•œ ì¢Œì„ì´ "ì´ë¯¸ ì„ íƒë¨"ìœ¼ë¡œ ë³´ì„ (ê³¼ì‰ ë°©ì–´)
> - ë°˜ëŒ€(ì¤‘ë³µ ì˜ˆì•½)ëŠ” ì ˆëŒ€ ë¶ˆê°€ â†’ DB ê²€ì¦ì´ ìµœì¢… ë°©ì–´ì„ 

### Q9. "ì´ ì‹œìŠ¤í…œì„ 10ë°° íŠ¸ë˜í”½ìœ¼ë¡œ ìŠ¤ì¼€ì¼ ì•„ì›ƒí•œë‹¤ë©´?"

**ë‹µë³€**:
> **ìˆ˜í‰ í™•ì¥ ì „ëµ**:
> 1. **ì• í”Œë¦¬ì¼€ì´ì…˜**: ì„œë²„ ì¸ìŠ¤í„´ìŠ¤ 10ê°œë¡œ ì¦ê°€ â†’ ë¶„ì‚° ë½ìœ¼ë¡œ ë™ê¸°í™” ë³´ì¥
> 2. **DB**: Read Replica ì¶”ê°€ â†’ ì¡°íšŒëŠ” Replica, ì“°ê¸°ëŠ” Master
> 3. **Redis**: Redis Cluster â†’ íŒŒí‹°ì…”ë‹ìœ¼ë¡œ ë¶€í•˜ ë¶„ì‚°
> 4. **Kafka**: íŒŒí‹°ì…˜ ìˆ˜ ì¦ê°€ (4 â†’ 40) â†’ ì»¨ìŠˆë¨¸ ê·¸ë£¹ ë³‘ë ¬ ì²˜ë¦¬
>
> **ë³‘ëª© ì§€ì  ì˜ˆì¸¡**:
> - DB ì“°ê¸°ê°€ ë‹¨ì¼ ì§€ì  â†’ CQRS íŒ¨í„´ ê³ ë ¤
> - Redis ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ â†’ Cluster ì „í™˜
> - Kafka íŒŒí‹°ì…˜ ìˆ˜ â†’ ì‚¬ì „ ì¶©ë¶„íˆ í™•ë³´

### Q10. "ì´ í”„ë¡œì íŠ¸ì—ì„œ ê°€ì¥ ì–´ë ¤ì› ë˜ ì ì€?"

**ë‹µë³€**:
> **ë¶„ì‚° ë½ê³¼ íŠ¸ëœì­ì…˜ ë²”ìœ„ ì„¤ê³„**ê°€ ê°€ì¥ ì–´ë ¤ì› ìŠµë‹ˆë‹¤.
>
> ì´ˆê¸°ì—ëŠ” íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ë½ì„ íšë“í•˜ë ¤ í–ˆëŠ”ë°, íŠ¸ëœì­ì…˜ì´ ë¡¤ë°±ë˜ì–´ë„ ë½ì€ ê·¸ëŒ€ë¡œ ë‚¨ëŠ” ë¬¸ì œê°€ ìˆì—ˆìŠµë‹ˆë‹¤. ê²°êµ­ **ë½ ë²”ìœ„ > íŠ¸ëœì­ì…˜ ë²”ìœ„**ë¡œ ì„¤ê³„í•˜ì—¬ í•´ê²°í–ˆìŠµë‹ˆë‹¤.
>
> ë˜í•œ Redis ìºì‹œì™€ DBì˜ ì¼ê´€ì„±ì„ ì–´ë””ê¹Œì§€ ë³´ì¥í• ì§€ ê³ ë¯¼ì´ ë§ì•˜ìŠµë‹ˆë‹¤. ìµœì¢…ì ìœ¼ë¡œ **DBë¥¼ ì§„ì‹¤ì˜ ì›ì²œìœ¼ë¡œ, RedisëŠ” ì„±ëŠ¥ ìµœì í™” ë ˆì´ì–´**ë¡œ ì—­í• ì„ ëª…í™•íˆ ë¶„ë¦¬í–ˆìŠµë‹ˆë‹¤.

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [Redisson ê³µì‹ ë¬¸ì„œ](https://redisson.org/)
- [Spring Kafka ë ˆí¼ëŸ°ìŠ¤](https://docs.spring.io/spring-kafka/reference/)
- [ë¶„ì‚° ì‹œìŠ¤í…œì—ì„œì˜ ë™ì‹œì„± ì œì–´](https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html)
- [ì´ë²¤íŠ¸ ê¸°ë°˜ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤](https://microservices.io/patterns/data/event-driven-architecture.html)

---

## ğŸ“ License

ì´ í”„ë¡œì íŠ¸ëŠ” í•™ìŠµ ëª©ì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
